<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="vaadin-radio-button.html">

<dom-module id="vaadin-radio-button-group-default-theme" theme-for="vaadin-radio-button-group">
  <template>
    <style>
      :host {
        display: inline-block;
        outline: none;
      }

      [part="wrapper"] {
        display: inline-flex;
        align-items: center;
        outline: none;
      }

      :host([invalid]) [part="wrapper"] {
        box-shadow: 0 0 1px red;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-radio-button-group">
  <template>
    <div part="wrapper" id="wrapper">
      <slot></slot>
    </div>
  </template>

  <script>
    if (!Polymer.Element) {
      throw new Error(`Unexpected Polymer version ${Polymer.version} is used, expected v2.0.0 or later.`);
    }

    (function() {
      /**
       * `<vaadin-radio-button-group>` is a Polymer element for grouping vaadin-radio-buttons.
       *
       * ```html
       * <vaadin-radio-button-group>
       *   <vaadin-radio-button>1</vaadin-radio-button>
       *   <vaadin-radio-button>2</vaadin-radio-button>
       *   <vaadin-radio-button>3</vaadin-radio-button>
       * </vaadin-radio-button-group>
       * ```
       *
       * ### Styling
       *
       * The following attributes are exposed for styling:
       *
       * Attribute    | Description
       * -------------|------------
       * `active`     | Set when the checkbox is pressed down, either with mouse, touch or the keyboard.
       * `disabled`   | Set when the checkbox is disabled.
       * `focus-ring` | Set when the checkbox is focused using the keyboard.
       * `focused`    | Set when the checkbox is focused.
       *
       * @memberof Vaadin
       * @mixes Vaadin.ControlStateMixin
       * @mixes Vaadin.ThemableMixin
       * @element vaadin-radio-button-group
       * @demo demo/index.html
       */
      class RadioButtonGroupElement extends Vaadin.ThemableMixin(Polymer.Element) {
        static get is() {
          return 'vaadin-radio-button-group';
        }

        static get properties() {
          return {
            name: {
              type: String,
              reflectToAttribute: true
            },

            value: {
              type: String,
              notify: true,
              observer: '_valueChanged',
              reflectToAttribute: true
            },

            required: {
              type: Boolean,
              reflectToAttribute: true
            },

            disabled: {
              type: Boolean,
              reflectToAttribute: true,
              observer: '_disabledChanged'
            }
          };
        }

        ready() {
          super.ready();

          this._addActiveListeners();

          this.addEventListener('radio-changed', e => {
            if (e.target.checked) {
              this.value = e.target.value;
            }
          });
        }

        _disabledChanged(disabled) {
          this.validate();

          this._forEachButton(button => button.disabled = disabled);
        }

        _addActiveListeners() {
          this.addEventListener('keydown', e => {
            if (this.disabled) {
              return;
            }

            // LEFT, UP - select previous radio button
            if (e.keyCode === 37 || e.keyCode === 38) {
              e.preventDefault();
              this._selectPreviousButton(e.target);
            }

            // RIGHT, DOWN - select next radio button
            if (e.keyCode === 39 || e.keyCode === 40) {
              e.preventDefault();
              this._selectNextButton(e.target);
            }
          });
        }

        _selectButton(element) {
          element.focus();
          this.value = element.value;
        }

        _selectNextButton(element) {
          if (element.nextElementSibling) {
            this._selectButton(element.nextElementSibling);
          } else {
            this._selectButton(this.firstElementChild);
          }
        }

        _selectPreviousButton(element) {
          if (element.previousElementSibling) {
            this._selectButton(element.previousElementSibling);
          } else {
            this._selectButton(this.lastElementChild);
          }
        }

        _forEachButton(fn) {
          Array.prototype.forEach.call(this.querySelectorAll('vaadin-radio-button'), fn);
        }

        _valueChanged(value) {
          this.validate();

          this._forEachButton(button => button.checked = button.value === value);
        }

        validate() {
          if (!this.value && this.required && !this.disabled) {
            this.setAttribute('invalid', '');
            return false;
          } else {
            this.removeAttribute('invalid');
            return true;
          }
        }
      }

      customElements.define(RadioButtonGroupElement.is, RadioButtonGroupElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin = window.Vaadin || {};
      Vaadin.RadioButtonGroupElement = RadioButtonGroupElement;
    })();
  </script>
</dom-module>
